<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simultane Ã‡eviri (Web, Tek Dosya)</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .title{font-size:clamp(20px,3.5vw,36px);font-weight:800;letter-spacing:.2px;margin:4px 0 14px}
    .subtitle{color:var(--muted);margin-bottom:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(148,163,184,.18);border-radius:18px;padding:14px 14px 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    select,input[type="text"],input[type="password"],input[type="url"],textarea{background:#0b1220;border:1px solid rgba(148,163,184,.3);color:var(--text);padding:10px 12px;border-radius:12px;outline:none;width:100%}
    select:focus,input:focus,textarea:focus{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    button{appearance:none;border:none;border-radius:14px;padding:12px 14px;font-weight:700;cursor:pointer;transition:.18s transform ease,.18s opacity ease;display:inline-flex;gap:8px;align-items:center}
    button:hover{transform:translateY(-1px)}
    .primary{background:var(--accent);color:#001a09}
    .ghost{background:#0b1220;color:#cbd5e1;border:1px solid rgba(148,163,184,.3)}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid rgba(148,163,184,.25);color:#cbd5e1}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .logs{height:140px;overflow:auto;white-space:pre-wrap;background:#0b1220;border:1px solid rgba(148,163,184,.3);border-radius:12px;padding:10px}
    .transcript{min-height:80px}
    .level{height:8px;border-radius:999px;background:#0b1220;border:1px solid rgba(148,163,184,.25);overflow:hidden}
    .level > i{display:block;height:100%;width:6%;background:linear-gradient(90deg, rgba(96,165,250,.8), rgba(34,197,94,.8));transition:width .08s ease}
    .footer{margin-top:16px;font-size:12px;color:var(--muted)}
    .ok{color:#22c55e}.err{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Simultane Ã‡eviri</div>
    <div class="subtitle">Telefonunuzda tek dosya <span class="badge">index.html</span> olarak Ã§alÄ±ÅŸÄ±r. Mikrofonu dinler, yazÄ±ya dÃ¶ker, seÃ§ilen saÄŸlayÄ±cÄ±yla Ã§evirir ve hedef dilde <em>sesli</em> okur.</div>

    <div class="card stack">
      <div class="row">
        <div class="stack" style="min-width:220px;flex:1">
          <label>Ã‡eviri SaÄŸlayÄ±cÄ±sÄ±</label>
          <select id="provider">
            <option value="none">(Ã‡eviri olmadan â€“ test)</option>
            <option value="libre">LibreTranslate / uyumlu API</option>
            <option value="deepl">DeepL API</option>
            <option value="openai">OpenAI (Chat Completions)</option>
          </select>
          <div class="note">TarayÄ±cÄ±dan doÄŸrudan API Ã§aÄŸrÄ±sÄ± bazÄ± saÄŸlayÄ±cÄ±larda CORS nedeniyle Ã§alÄ±ÅŸmayabilir. Gerekirse kendi <span class="mono">/proxy</span> uÃ§ noktanÄ±zÄ± kullanÄ±n.</div>
        </div>
        <div class="stack flex-1" id="libreBox" style="display:none">
          <label>LibreTranslate UÃ§ NoktasÄ±</label>
          <input type="url" id="libreEndpoint" placeholder="https://libretranslate.com/translate" />
        </div>
        <div class="stack flex-1" id="deeplBox" style="display:none">
          <label>DeepL API AnahtarÄ±</label>
          <input type="password" id="deeplKey" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:fx" />
        </div>
        <div class="stack flex-1" id="openaiBox" style="display:none">
          <label>OpenAI API AnahtarÄ±</label>
          <input type="password" id="openaiKey" placeholder="sk-..." />
        </div>
      </div>
      <div class="row">
        <div class="stack" style="min-width:220px;flex:1">
          <label>Benim Dilim (Kaynak)</label>
          <select id="sourceLang"></select>
        </div>
        <div class="stack" style="min-width:220px;flex:1">
          <label>KarÅŸÄ± TarafÄ±n Dili (Hedef)</label>
          <select id="targetLang"></select>
        </div>
        <div class="stack" style="min-width:200px;flex:1">
          <label>Hedef Ses (Okunacak Ses)</label>
          <select id="voiceSelect"></select>
          <div class="note">Ses seÃ§enekleri cihazdaki <em>SpeechSynthesis</em> seslerine gÃ¶re listelenir.</div>
        </div>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">â–¶ BaÅŸlat</button>
        <button id="stopBtn" class="ghost">â–  Durdur</button>
        <button id="flipBtn" class="ghost" title="Kaynak â†” Hedef dillerini deÄŸiÅŸtir">â†”ï¸ Dilleri DeÄŸiÅŸtir</button>
        <span id="status" class="pill">HazÄ±r</span>
        <span id="warn" class="pill" style="display:none;background:#0b1220;border-color:#f59e0b;color:#fbbf24">iOS Safari, web'de tanÄ±mayÄ± sÄ±nÄ±rlayabilir</span>
      </div>
      <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px">
        <div class="stack" style="min-width:220px">
          <label>CÃ¼mle AlgÄ±lama</label>
          <div class="row" style="gap:8px">
            <label class="pill"><input id="detectPunct" type="checkbox" style="margin-right:6px"/>Noktalama ile</label>
            <label class="pill"><input id="detectPause" type="checkbox" style="margin-right:6px"/>Duraklama ile</label>
            <input id="pauseMs" type="range" min="300" max="1500" step="50" value="700" style="width:200px"/>
            <span class="note" id="pauseLabel">700 ms</span>
          </div>
        </div>
        <div class="stack" style="min-width:220px">
          <label>Okuma HÄ±zÄ± & Pitch</label>
          <div class="row" style="gap:8px">
            <span class="note">HÄ±z</span>
            <input id="rate" type="range" min="0.5" max="1.8" step="0.1" value="1" style="width:160px"/>
            <span class="note" id="rateLabel">1.0x</span>
            <span class="note" style="margin-left:10px">Pitch</span>
            <input id="pitch" type="range" min="0.5" max="2" step="0.1" value="1" style="width:160px"/>
            <span class="note" id="pitchLabel">1.0</span>
          </div>
        </div>
      </div>

      <div class="row" style="align-items:flex-end">
        <div class="stack flex-1">
          <label>Ben SÃ¶ylerken (TanÄ±ma)</label>
          <div id="myTranscript" class="logs transcript"></div>
          <div class="level"><i id="lvl"></i></div>
          <div class="stack">
            <label>Elle GiriÅŸ</label>
            <textarea id="manualInput" class="logs" style="height:68px" placeholder="Elle metin gir (Ctrl/âŒ˜ + Enter ile gÃ¶nder)"></textarea>
            <div class="row">
              <button id="sendManual" class="primary">âœï¸ Metni Ã‡evir & Oku</button>
              <span class="note">KÄ±sayol: Ctrl/âŒ˜ + Enter</span>
            </div>
          </div>
          <div class="row">
            <button id="pttMe" class="ghost" title="Bas-KonuÅŸ">ğŸ™ï¸ Bas & KonuÅŸ</button>
            <button id="copyMy" class="ghost">Kopyala</button>
            <span class="note">KÄ±sa cÃ¼mleler ve duraklamalar tanÄ±mayÄ± hÄ±zlandÄ±rÄ±r.</span>
          </div>
        </div>
        <div class="stack flex-1">
          <label>KarÅŸÄ± Tarafa Okunan (Ã‡eviri + TTS)</label>
          <div id="toOther" class="logs transcript"></div>
          <div class="row">
            <button id="testSay" class="ghost">ğŸ”Š Test Oku</button>
            <button id="copyOther" class="ghost">Kopyala</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card stack">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="stack" style="max-width:680px">
          <strong>Ä°ki YÃ¶nlÃ¼ (Backâ€‘toâ€‘Back) Mod</strong>
          <div class="note">KarÅŸÄ± taraf konuÅŸurken ayrÄ± bir butona basÄ±p Ã§evirisini kendi dilinizde dinleyin. AynÄ± anda iki tanÄ±ma oturumu tarayÄ±cÄ±larda Ã§akÄ±ÅŸabileceÄŸi iÃ§in <em>basâ€‘konuÅŸ</em> yaklaÅŸÄ±mÄ± daha kararlÄ±dÄ±r.</div>
        </div>
        <div><span class="badge">Opsiyonel</span></div>
      </div>

      <div class="row" style="align-items:flex-end">
        <div class="stack flex-1">
          <label>KarÅŸÄ± KiÅŸi SÃ¶ylerken (TanÄ±ma â€“ Hedef Dilde)</label>
          <div id="otherTranscript" class="logs transcript"></div>
          <div class="row">
            <button id="pttOther" class="ghost">ğŸ™ï¸ KarÅŸÄ± Taraf KonuÅŸsun</button>
            <button id="copyOtherSrc" class="ghost">Kopyala</button>
          </div>
          <div class="stack">
            <label>KarÅŸÄ± Taraf Elle GiriÅŸ</label>
            <textarea id="manualInputOther" class="logs" style="height:68px" placeholder="KarÅŸÄ± tarafÄ±n sÃ¶ylediÄŸini hedef dilde yaz (Ctrl/âŒ˜ + Enter)"></textarea>
            <div class="row">
              <button id="sendManualOther" class="primary">âœï¸ Metni Bana Ã‡evir & Oku</button>
              <span class="note">KÄ±sayol: Ctrl/âŒ˜ + Enter</span>
            </div>
          </div>
        </div>
        <div class="stack flex-1">
          <label>Sana Okunan (Ã‡eviri + TTS)</label>
          <div id="toMe" class="logs transcript"></div>
          <div class="row">
            <button id="testSayMe" class="ghost">ğŸ”Š Test Oku</button>
            <button id="copyToMe" class="ghost">Kopyala</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card stack">
      <strong>TanÄ±lama / Testler</strong>
      <div class="note">AÅŸaÄŸÄ±daki hÄ±zlÄ± testler yalnÄ±zca tarayÄ±cÄ± tarafÄ±nda Ã§alÄ±ÅŸÄ±r, API Ã§aÄŸrÄ±sÄ± yapmaz.</div>
      <div class="row">
        <button id="runTests" class="ghost">â–¶ Selfâ€‘Test Ã‡alÄ±ÅŸtÄ±r</button>
        <span class="note">SonuÃ§lar: <span id="testSummary" class="mono"></span></span>
      </div>
      <textarea id="testLog" class="logs" style="height:120px" readonly></textarea>
    </div>

    <div class="footer">
      <div>âš ï¸ <strong>Gizlilik/Ãœcret:</strong> SeÃ§tiÄŸiniz API'ye gÃ¶nderilen metinler saÄŸlayÄ±cÄ±nÄ±za iletilir. Mobil tarayÄ±cÄ±da doÄŸrudan anahtar kullanÄ±mÄ± iÃ§in kendi CORS proxy'nizi Ã¶neririz.</div>
      <div>ğŸ’¡ <strong>Ä°pucu:</strong> Ana ekrana ekleyerek (PWA olmadan) hÄ±zlÄ± baÅŸlatabilirsiniz. Diller ve anahtarlar yerelde saklanÄ±r.</div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const els = {
      provider: $('#provider'), libreBox: $('#libreBox'), deeplBox: $('#deeplBox'), openaiBox: $('#openaiBox'),
      libreEndpoint: $('#libreEndpoint'), deeplKey: $('#deeplKey'), openaiKey: $('#openaiKey'),
      sourceLang: $('#sourceLang'), targetLang: $('#targetLang'), voiceSelect: $('#voiceSelect'),
      startBtn: $('#startBtn'), stopBtn: $('#stopBtn'), flipBtn: $('#flipBtn'), status: $('#status'), warn: $('#warn'),
      myTranscript: $('#myTranscript'), toOther: $('#toOther'), lvl: $('#lvl'), pttMe: $('#pttMe'), copyMy: $('#copyMy'), copyOther: $('#copyOther'),
      otherTranscript: $('#otherTranscript'), toMe: $('#toMe'), pttOther: $('#pttOther'), copyOtherSrc: $('#copyOtherSrc'), copyToMe: $('#copyToMe'),
      testSay: $('#testSay'), testSayMe: $('#testSayMe'),
      detectPunct: $('#detectPunct'), detectPause: $('#detectPause'), pauseMs: $('#pauseMs'), pauseLabel: $('#pauseLabel'),
      rate: $('#rate'), pitch: $('#pitch'), rateLabel: $('#rateLabel'), pitchLabel: $('#pitchLabel'),
      manualInput: $('#manualInput'), sendManual: $('#sendManual'),
      manualInputOther: $('#manualInputOther'), sendManualOther: $('#sendManualOther'),
      runTests: $('#runTests'), testLog: $('#testLog'), testSummary: $('#testSummary'),
    };

    const SUPPORTED_LANGS = [
      {code:'tr-TR', name:'TÃ¼rkÃ§e'}, {code:'en-US', name:'Ä°ngilizce (ABD)'}, {code:'en-GB', name:'Ä°ngilizce (UK)'},
      {code:'de-DE', name:'Almanca'}, {code:'fr-FR', name:'FransÄ±zca'}, {code:'es-ES', name:'Ä°spanyolca'}, {code:'it-IT', name:'Ä°talyanca'},
      {code:'ru-RU', name:'RusÃ§a'}, {code:'ar-SA', name:'ArapÃ§a'}, {code:'fa-IR', name:'FarsÃ§a'}, {code:'el-GR', name:'Yunanca'},
      {code:'bg-BG', name:'Bulgarca'}, {code:'ro-RO', name:'Romence'}, {code:'nl-NL', name:'FlemenkÃ§e'}, {code:'pt-PT', name:'Portekizce'},
      {code:'hi-IN', name:'HintÃ§e'}, {code:'ja-JP', name:'Japonca'}, {code:'ko-KR', name:'Korece'}, {code:'zh-CN', name:'Ã‡ince (BasitleÅŸtirilmiÅŸ)'}
    ];

    function fillLangs(){
      els.sourceLang.innerHTML = SUPPORTED_LANGS.map(l=>`<option value="${l.code}">${l.name}</option>`).join('');
      els.targetLang.innerHTML = SUPPORTED_LANGS.map(l=>`<option value="${l.code}">${l.name}</option>`).join('');
      const s = localStorage.getItem('sim-src') || 'tr-TR';
      const t = localStorage.getItem('sim-tgt') || 'en-US';
      els.sourceLang.value = s; els.targetLang.value = t;
    }

    function saveSettings(){
      localStorage.setItem('sim-provider', els.provider.value);
      localStorage.setItem('sim-libre', els.libreEndpoint.value||'');
      localStorage.setItem('sim-deepl', els.deeplKey.value||'');
      localStorage.setItem('sim-openai', els.openaiKey.value||'');
      localStorage.setItem('sim-src', els.sourceLang.value);
      localStorage.setItem('sim-tgt', els.targetLang.value);
      localStorage.setItem('sim-voice', els.voiceSelect.value||'');
      localStorage.setItem('sim-detectPunct', els.detectPunct.checked?'1':'0');
      localStorage.setItem('sim-detectPause', els.detectPause.checked?'1':'0');
      localStorage.setItem('sim-pauseMs', String(els.pauseMs.value));
      localStorage.setItem('sim-rate', String(els.rate.value));
      localStorage.setItem('sim-pitch', String(els.pitch.value));
    }

    function loadSettings(){
      els.provider.value = localStorage.getItem('sim-provider') || 'none';
      els.libreEndpoint.value = localStorage.getItem('sim-libre') || 'https://libretranslate.com/translate';
      els.deeplKey.value = localStorage.getItem('sim-deepl') || '';
      els.openaiKey.value = localStorage.getItem('sim-openai') || '';
      els.detectPunct.checked = (localStorage.getItem('sim-detectPunct')||'1')==='1';
      els.detectPause.checked = (localStorage.getItem('sim-detectPause')||'0')==='1';
      els.pauseMs.value = localStorage.getItem('sim-pauseMs') || '700'; els.pauseLabel.textContent = els.pauseMs.value+' ms';
      els.rate.value = localStorage.getItem('sim-rate') || '1'; els.rateLabel.textContent = Number(els.rate.value).toFixed(1)+'x';
      els.pitch.value = localStorage.getItem('sim-pitch') || '1'; els.pitchLabel.textContent = Number(els.pitch.value).toFixed(1);
    }

    function uiProvider(){
      els.libreBox.style.display = els.provider.value==='libre' ? '' : 'none';
      els.deeplBox.style.display = els.provider.value==='deepl' ? '' : 'none';
      els.openaiBox.style.display = els.provider.value==='openai' ? '' : 'none';
    }

    // Speech Synthesis Voices
    let voices = [];
    function populateVoices(){
      voices = speechSynthesis.getVoices();
      const options = voices.map(v=>{
        const label = `${v.name} â€“ ${v.lang}${v.default?' (varsayÄ±lan)':''}`;
        return `<option value="${v.name}" data-lang="${v.lang}">${label}</option>`;
      }).join('');
      els.voiceSelect.innerHTML = `<option value="">(Otomatik â€“ hedef dile en yakÄ±n)</option>` + options;
      const saved = localStorage.getItem('sim-voice');
      if(saved) els.voiceSelect.value = saved;
    }
    speechSynthesis.onvoiceschanged = populateVoices;

    // Mic level (simple analyser)
    let mediaStream, audioCtx, analyser, dataArray;
    async function setupLevel(){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(mediaStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256; dataArray = new Uint8Array(analyser.frequencyBinCount);
        source.connect(analyser);
        raf();
      }catch(err){/* mic level optional */}
    }
    function raf(){
      if(!analyser) return; analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length; // 0..255
      const w = Math.min(100, Math.max(2, (avg/255)*100));
      els.lvl.style.width = w+'%';
      requestAnimationFrame(raf);
    }

    // Speech Recognition helper
    function createRecognizer(lang){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.continuous = false; // kÄ±sa cÃ¼mleler, onend ile yeniden baÅŸlatÄ±yoruz
      r.interimResults = true;
      r.lang = lang;
      r.onstart = ()=>{ els.status.textContent = 'Mikrofon dinleniyorâ€¦'; };
      r.onaudiostart = ()=>{ els.status.textContent = 'Ses alÄ±nÄ±yorâ€¦'; };
      r.onspeechstart = ()=>{ els.status.textContent = 'KonuÅŸma algÄ±landÄ±'; };
      r.onspeechend = ()=>{ els.status.textContent = 'KonuÅŸma bitti, iÅŸleniyorâ€¦'; };
      r.onaudioend = ()=>{ /* sessizlik */ };
      r.onerror = (e)=>{
        const m = e?.error;
        let hint = '';
        if(m==='no-speech') hint = 'Mikrofondan ses gelmedi. Mikrofon seÃ§imini kontrol et.';
        else if(m==='audio-capture') hint = 'Mikrofon bulunamadÄ±/engellendi. TarayÄ±cÄ± izinlerini kontrol et.';
        else if(m==='not-allowed') hint = 'Ä°zin verilmedi. Adres Ã§ubuÄŸundaki mikrofon simgesinden izin verin.';
        else if(m==='aborted') hint = 'Oturum sonlandÄ±. Tekrar baÅŸlatÄ±lÄ±yorâ€¦';
        else hint = 'Hata: '+m;
        els.status.textContent = 'Hata: '+m;
        els.testLog.value += `âŒ SR hata: ${m} ${hint?('â€“ '+hint):''}\n`;
      };
      return r;
    }

    // Sentence extraction
    function takeCompleteSentences(buffer){
      const complete = [];
      let current = '';
      const enders = '.!?â€¦';
      for(const ch of (buffer||'')){
        current += ch;
        if(enders.includes(ch)){
          complete.push(current.trim());
          current = '';
        }
      }
      return {complete, rest: current.trimStart()};
    }

    // Anti-echo (input)
    function collapseRepeats(text){
      let t = (text || '').replace(/\s+/g,' ').trim();
      if(!t) return '';
      const out = [];
      const words = t.split(' ');
      let last = '', run = 0;
      for(const w of words){
        const lw = w.toLowerCase();
        if(lw === last){ run++; if(run > 2) continue; }
        else { last = lw; run = 1; }
        out.push(w);
      }
      t = out.join(' ');
      const toks = t.split(' ');
      const filt = [];
      for(let i=0;i<toks.length;i++){
        const cur = toks[i];
        const p1 = filt[filt.length-1], p2 = filt[filt.length-2];
        if(p2 && p1 && (p2+' '+p1).toLowerCase() === ((toks[i-1]||'')+' '+cur).toLowerCase()){
          continue; // repeating bigram
        }
        filt.push(cur);
      }
      return filt.join(' ').trim();
    }
    function diceSim(a,b){
      if(!a||!b) return 0;
      const A = new Set(), B = new Set();
      const ta = a.toLowerCase(), tb = b.toLowerCase();
      for(let i=0;i<ta.length-2;i++) A.add(ta.slice(i,i+3));
      for(let i=0;i<tb.length-2;i++) B.add(tb.slice(i,i+3));
      if(!A.size || !B.size) return 0;
      let inter = 0; for(const x of A) if(B.has(x)) inter++;
      return (2*inter)/(A.size+B.size);
    }
    const recentSrc = { me: [], other: [] };
    function shouldSkipEcho(slot, chunk){
      const list = (slot === 'toOther') ? recentSrc.me : recentSrc.other;
      const norm = collapseRepeats(chunk);
      if(norm.length < 3) return true;
      const last = list[list.length-1] || '';
      if(norm === last) return true;
      if(diceSim(norm, last) > 0.90) return true;
      for(let i=list.length-2; i>=Math.max(0, list.length-3); i--){ if(diceSim(norm, list[i]) > 0.92) return true; }
      list.push(norm); if(list.length > 6) list.shift();
      return false;
    }

    // Translation providers
    async function translateText(text, from, to){
      const provider = els.provider.value;
      if(!text || from===to || provider==='none') return text;

      if(provider==='libre'){
        const ep = (els.libreEndpoint.value||'').trim();
        const body = {q:text, source: from.split('-')[0], target: to.split('-')[0], format:'text'};
        const res = await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!res.ok) throw new Error('LibreTranslate hata: '+res.status);
        const js = await res.json();
        return js.translatedText || js.translation || text;
      }

      if(provider==='deepl'){
        const key = (els.deeplKey.value||'').trim();
        const res = await fetch('https://api-free.deepl.com/v2/translate',{method:'POST',headers:{'Authorization':'DeepL-Auth-Key '+key,'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({text:text, target_lang: to.split('-')[0].toUpperCase()})});
        if(!res.ok) throw new Error('DeepL hata: '+res.status);
        const js = await res.json();
        return (js.translations && js.translations[0] && js.translations[0].text) || text;
      }

      if(provider==='openai'){
        const key = (els.openaiKey.value||'').trim();
        const payload = {
          model: 'gpt-4o-mini',
          messages: [
            {role:'system', content:'You are a translation engine. Translate the user input preserving meaning and tone. Output only the translated text.'},
            {role:'user', content:`From ${from} to ${to}. Text: ${text}`}
          ],
          temperature: 0.2
        };
        const res = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(payload)});
        if(!res.ok) throw new Error('OpenAI hata: '+res.status);
        const js = await res.json();
        const out = js.choices?.[0]?.message?.content?.trim();
        return out || text;
      }

      return text;
    }

    // TTS + ducking + gÃ¼Ã§lÃ¼ dedupe
    function makeUtterance(text, targetLang){
      const u = new SpeechSynthesisUtterance(text);
      const pickedName = els.voiceSelect.value;
      if(pickedName){
        const v = speechSynthesis.getVoices().find(v=>v.name===pickedName); if(v) u.voice = v;
      } else {
        const pref = targetLang.split('-')[0];
        const v = speechSynthesis.getVoices().find(v=>v.lang && v.lang.toLowerCase().startsWith(pref)); if(v) u.voice = v;
      }
      u.lang = (u.voice?.lang)||targetLang;
      u.rate = parseFloat(els.rate.value||'1');
      u.pitch = parseFloat(els.pitch.value||'1');
      return u;
    }
    const tts = { queue: [], busy: false, recent: new Map(), last: { toOther: '', toMe: '' } };
    let suspendMe = false, suspendOther = false;

    function processTTS(){
      if(tts.busy) return; const job = tts.queue.shift(); if(!job) return;
      tts.busy = true;
      if(job.slot === 'toOther' && activeMe){ suspendMe = true; try{ recMe && recMe.stop(); }catch{} els.status.textContent = 'Okunuyorâ€¦ (mikrofon kapalÄ±)'; }
      if(job.slot === 'toMe' && activeOther){ suspendOther = true; try{ recOther && recOther.stop(); }catch{} }
      const u = makeUtterance(job.text, job.lang);
      u.onend = u.onerror = ()=>{
        if(job.slot === 'toOther'){
          suspendMe = false; if(activeMe){ try{ recMe && recMe.start(); }catch{} els.status.textContent = 'Dinleniyorâ€¦'; }
        }
        if(job.slot === 'toMe'){
          suspendOther = false; if(activeOther){ try{ recOther && recOther.start(); }catch{} }
        }
        tts.busy = false; processTTS();
      };
      speechSynthesis.speak(u);
    }

    function speakOnce(slot, text, lang){
      const norm = (text||'').replace(/\s+/g,' ').trim(); if(!norm) return;
      // temel dedupe (eski)
      if(tts.last && (tts.last[slot]||'').replace(/\s+/g,' ').trim() === norm) return;
      const key = slot+'|'+norm.toLowerCase(); const now = Date.now(); const last = tts.recent.get(key)||0;
      if(now - last < 8000) return;
      tts.recent.set(key, now);
      tts.last[slot] = norm;
      tts.queue.push({text: norm, lang, slot});
      processTTS();
    }

    // daha gÃ¼Ã§lÃ¼ wrapper: kuyruk + benzerlik dedupe
    function speakOnceSafe(slot, text, lang){
      const norm = (text||'').replace(/\s+/g,' ').trim(); if(!norm) return;
      const last = (tts.last && tts.last[slot]) ? tts.last[slot].replace(/\s+/g,' ').trim() : '';
      if(last && diceSim(norm, last) > 0.95) return;
      for(const j of tts.queue){ if(j.slot===slot && diceSim(norm, (j.text||'').replace(/\s+/g,' ').trim())>0.95) return; }
      const key = slot+'|'+norm.toLowerCase(); const now = Date.now(); const prev = tts.recent.get(key)||0; if(now - prev < 8000) return;
      speakOnce(slot, norm, lang);
    }

    // Me -> Other
    let recMe = null, activeMe = false, lastChunkMe = '';
    let bufferMe = '', pauseTimerMe = null;
    function startMe(){
      if(activeMe) return; activeMe = true; els.status.textContent = 'Dinleniyorâ€¦';
      const lang = els.sourceLang.value;
      recMe = createRecognizer(lang);
      if(!recMe){
        els.status.textContent='KonuÅŸma TanÄ±ma desteklenmiyor';
        const ua = navigator.userAgent;
        els.testLog.value += `âŒ SR yok. TarayÄ±cÄ±: ${ua}\n`;
        alert('Bu tarayÄ±cÄ±da Web Speech Recognition yok. LÃ¼tfen Chrome veya Edge kullanÄ±n.');
        activeMe = false; return;
      }
      recMe.onresult = async (ev)=>{
        let interim=''; let final='';
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          const res = ev.results[i];
          const txt = (res[0].transcript||'').trim();
          if(res.isFinal){ final += txt + ' '; } else { interim += txt + ' '; }
        }
        const combined = (final + (interim?(' '+interim):'')).trim();
        els.myTranscript.textContent = combined;

        const usePunct = els.detectPunct?.checked;
        const usePause = els.detectPause?.checked;
        const ms = parseInt(els.pauseMs?.value||'700',10);

        if(usePunct){
          bufferMe += (final?final+' ':'');
          const parts = takeCompleteSentences(bufferMe);
          if(parts.complete.length){
            for(const sentence of parts.complete){
              if(!sentence) continue;
              const cleaned = collapseRepeats(sentence);
              if(cleaned && cleaned !== lastChunkMe && !shouldSkipEcho('toOther', cleaned)){
                lastChunkMe = cleaned;
                try{
                  const out = await translateText(cleaned, els.sourceLang.value, els.targetLang.value);
                  speakOnceSafe('toOther', out, els.targetLang.value);
                  if((els.toOther.dataset.last||'')!==out.trim()){ els.toOther.textContent += (els.toOther.textContent?' ':'')+out; els.toOther.dataset.last = out.trim(); }
                }catch(err){ els.toOther.textContent = (els.toOther.textContent||'') + ` [Ã§eviri hatasÄ±: ${err.message}]`; }
              }
            }
            bufferMe = parts.rest + ' ';
          }
        } else if(usePause){
          bufferMe += (interim?interim+' ':'') + (final?final+' ':'');
          if(pauseTimerMe) clearTimeout(pauseTimerMe);
          if(bufferMe.trim()){
            pauseTimerMe = setTimeout(async ()=>{
              const chunk = bufferMe.trim(); bufferMe='';
              if(chunk){
                const cleaned = collapseRepeats(chunk);
                if(cleaned && cleaned !== lastChunkMe && !shouldSkipEcho('toOther', cleaned)){
                  lastChunkMe = cleaned;
                  try{
                    const out = await translateText(cleaned, els.sourceLang.value, els.targetLang.value);
                    speakOnceSafe('toOther', out, els.targetLang.value);
                    if((els.toOther.dataset.last||'')!==out.trim()){ els.toOther.textContent += (els.toOther.textContent?' ':'')+out; els.toOther.dataset.last = out.trim(); }
                  }catch(err){ els.toOther.textContent = (els.toOther.textContent||'') + ` [Ã§eviri hatasÄ±: ${err.message}]`; }
                }
              }
            }, ms);
          }
        } else {
          if(final){
            const chunk = final.trim();
            if(chunk){
              const cleaned = collapseRepeats(chunk);
              if(cleaned && cleaned !== lastChunkMe && !shouldSkipEcho('toOther', cleaned)){
                lastChunkMe = cleaned;
                try{
                  const out = await translateText(cleaned, els.sourceLang.value, els.targetLang.value);
                  speakOnceSafe('toOther', out, els.targetLang.value);
                  if((els.toOther.dataset.last||'')!==out.trim()){ els.toOther.textContent += (els.toOther.textContent?' ':'')+out; els.toOther.dataset.last = out.trim(); }
                }catch(err){ els.toOther.textContent = (els.toOther.textContent||'') + ` [Ã§eviri hatasÄ±: ${err.message}]`; }
              }
            }
          }
        }
      };
      recMe.onend = ()=>{ if(activeMe && !suspendMe){ try{ recMe.start(); }catch(e){} } };
      try{ recMe.start(); }catch(e){}
    }
    function stopMe(){
      activeMe=false;
      try{ if(recMe) recMe.stop(); }catch(e){}
      els.status.textContent='Durdu';
      lastChunkMe=''; bufferMe=''; if(pauseTimerMe) clearTimeout(pauseTimerMe);
      if(tts){ tts.recent = new Map(); if(tts.last){ tts.last.toOther=''; } }
    }

    // Other -> Me
    let recOther=null, activeOther=false, lastChunkOther='';
    let bufferOther='', pauseTimerOther=null;
    function startOther(){
      if(activeOther) return; activeOther=true;
      const lang = els.targetLang.value;
      recOther = createRecognizer(lang);
      if(!recOther){ alert('KonuÅŸma TanÄ±ma desteklenmiyor.'); activeOther=false; return; }
      recOther.onresult = async (ev)=>{
        let interim=''; let final='';
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          const res = ev.results[i];
          const txt = (res[0].transcript||'').trim();
          if(res.isFinal){ final += txt + ' '; } else { interim += txt + ' '; }
        }
        const combined = (final + (interim?(' '+interim):'')).trim();
        els.otherTranscript.textContent = combined;

        const usePunct = els.detectPunct?.checked;
        const usePause = els.detectPause?.checked;
        const ms = parseInt(els.pauseMs?.value||'700',10);

        if(usePunct){
          bufferOther += (final?final+' ':'');
          const parts = takeCompleteSentences(bufferOther);
          if(parts.complete.length){
            for(const sentence of parts.complete){
              if(!sentence) continue;
              const cleaned = collapseRepeats(sentence);
              if(cleaned && cleaned !== lastChunkOther && !shouldSkipEcho('toMe', cleaned)){
                lastChunkOther = cleaned;
                try{
                  const out = await translateText(cleaned, els.targetLang.value, els.sourceLang.value);
                  speakOnceSafe('toMe', out, els.sourceLang.value);
                  if((els.toMe.dataset.last||'')!==out.trim()){ els.toMe.textContent += (els.toMe.textContent?' ':'')+out; els.toMe.dataset.last = out.trim(); }
                }catch(err){ els.toMe.textContent = (els.toMe.textContent||'') + ` [Ã§eviri hatasÄ±: ${err.message}]`; }
              }
            }
            bufferOther = parts.rest + ' ';
          }
        } else if(usePause){
          bufferOther += (interim?interim+' ':'') + (final?final+' ':'');
          if(pauseTimerOther) clearTimeout(pauseTimerOther);
          if(bufferOther.trim()){
            pauseTimerOther = setTimeout(async ()=>{
              const chunk = bufferOther.trim(); bufferOther='';
              if(chunk){
                const cleaned = collapseRepeats(chunk);
                if(cleaned && cleaned !== lastChunkOther && !shouldSkipEcho('toMe', cleaned)){
                  lastChunkOther = cleaned;
                  try{
                    const out = await translateText(cleaned, els.targetLang.value, els.sourceLang.value);
                    speakOnceSafe('toMe', out, els.sourceLang.value);
                    if((els.toMe.dataset.last||'')!==out.trim()){ els.toMe.textContent += (els.toMe.textContent?' ':'')+out; els.toMe.dataset.last = out.trim(); }
                  }catch(err){ els.toMe.textContent = (els.toMe.textContent||'') + ` [Ã§eviri hatasÄ±: ${err.message}]`; }
                }
              }
            }, ms);
          }
        } else {
          if(final){
            const chunk = final.trim();
            if(chunk){
              const cleaned = collapseRepeats(chunk);
              if(cleaned && cleaned !== lastChunkOther && !shouldSkipEcho('toMe', cleaned)){
                lastChunkOther = cleaned;
                try{
                  const out = await translateText(cleaned, els.targetLang.value, els.sourceLang.value);
                  speakOnceSafe('toMe', out, els.sourceLang.value);
                  if((els.toMe.dataset.last||'')!==out.trim()){ els.toMe.textContent += (els.toMe.textContent?' ':'')+out; els.toMe.dataset.last = out.trim(); }
                }catch(err){ els.toMe.textContent = (els.toMe.textContent||'') + ` [Ã§eviri hatasÄ±: ${err.message}]`; }
              }
            }
          }
        }
      };
      recOther.onend = ()=>{ if(activeOther && !suspendOther){ try{ recOther.start(); }catch(e){} } };
      try{ recOther.start(); }catch(e){}
    }
    function stopOther(){
      activeOther = false;
      try { if(recOther) recOther.stop(); } catch(e){}
      lastChunkOther = ''; bufferOther = ''; if (pauseTimerOther) clearTimeout(pauseTimerOther);
      if(tts && tts.last){ tts.last.toMe=''; }
    }

    // PTT
    els.pttMe.addEventListener('mousedown', ()=>{ startMe(); });
    els.pttMe.addEventListener('mouseup',   ()=>{ stopMe(); });
    els.pttMe.addEventListener('touchstart',(e)=>{ e.preventDefault(); startMe(); });
    els.pttMe.addEventListener('touchend',  (e)=>{ e.preventDefault(); stopMe(); });

    els.pttOther.addEventListener('mousedown', ()=>{ startOther(); });
    els.pttOther.addEventListener('mouseup',   ()=>{ stopOther(); });
    els.pttOther.addEventListener('touchstart',(e)=>{ e.preventDefault(); startOther(); });
    els.pttOther.addEventListener('touchend',  (e)=>{ e.preventDefault(); stopOther(); });

    // Buttons
    els.startBtn.onclick = ()=>{ saveSettings(); startMe(); };
    els.stopBtn.onclick  = ()=>{ stopMe(); stopOther(); };
    els.flipBtn.onclick  = ()=>{ const s=els.sourceLang.value, t=els.targetLang.value; els.sourceLang.value=t; els.targetLang.value=s; saveSettings(); };
    els.testSay.onclick  = ()=>{ speakOnceSafe('toOther','Hello! This is a test voice for the other side.', els.targetLang.value); };
    els.testSayMe.onclick= ()=>{ speakOnceSafe('toMe','Merhaba! Bu ses denemesidir.', els.sourceLang.value); };

    // Elle giriÅŸ
    async function handleManualSend(){
      const text=(els.manualInput.value||'').trim();
      if(!text) return;
      const cleaned = collapseRepeats(text);
      if(!cleaned || shouldSkipEcho('toOther', cleaned)) { els.manualInput.value=''; return; }
      els.myTranscript.textContent=(els.myTranscript.textContent?els.myTranscript.textContent+' ':'')+cleaned;
      try{
        const out=await translateText(cleaned, els.sourceLang.value, els.targetLang.value);
        speakOnceSafe('toOther', out, els.targetLang.value);
        if((els.toOther.dataset.last||'')!==out.trim()){ els.toOther.textContent += (els.toOther.textContent?' ':'')+out; els.toOther.dataset.last = out.trim(); }
      }catch(e){ els.toOther.textContent+=(els.toOther.textContent?' ':'')+'[Ã§eviri hatasÄ±]'; }
      els.manualInput.value='';
    }
    els.sendManual.onclick = handleManualSend;
    els.manualInput.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); handleManualSend(); }});

    async function handleManualSendOther(){
      const text=(els.manualInputOther.value||'').trim();
      if(!text) return;
      const cleaned = collapseRepeats(text);
      if(!cleaned || shouldSkipEcho('toMe', cleaned)) { els.manualInputOther.value=''; return; }
      els.otherTranscript.textContent=(els.otherTranscript.textContent?els.otherTranscript.textContent+' ':'')+cleaned;
      try{
        const out=await translateText(cleaned, els.targetLang.value, els.sourceLang.value);
        speakOnceSafe('toMe', out, els.sourceLang.value);
        if((els.toMe.dataset.last||'')!==out.trim()){ els.toMe.textContent += (els.toMe.textContent?' ':'')+out; els.toMe.dataset.last = out.trim(); }
      }catch(e){ els.toMe.textContent+=(els.toMe.textContent?' ':'')+'[Ã§eviri hatasÄ±]'; }
      els.manualInputOther.value='';
    }
    els.sendManualOther.onclick = handleManualSendOther;
    els.manualInputOther.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); handleManualSendOther(); }});

    // Settings UI
    function onSettingsChange(){ saveSettings(); }
    els.provider.onchange = ()=>{ uiProvider(); saveSettings(); };
    ['libreEndpoint','deeplKey','openaiKey'].forEach(id=>{
      const inp = document.getElementById(id); if(!inp) return; inp.addEventListener('change', onSettingsChange); inp.addEventListener('blur', onSettingsChange);
    });
    els.sourceLang.onchange=onSettingsChange; els.targetLang.onchange=onSettingsChange; els.voiceSelect.onchange=onSettingsChange;
    els.pauseMs.oninput = ()=>{ els.pauseLabel.textContent = els.pauseMs.value+' ms'; saveSettings(); };
    els.detectPunct.onchange=()=>{ if(els.detectPunct.checked){ els.detectPause.checked=false; } saveSettings(); };
    els.detectPause.onchange=()=>{ if(els.detectPause.checked){ els.detectPunct.checked=false; } saveSettings(); };
    els.rate.oninput = ()=>{ els.rateLabel.textContent = Number(els.rate.value).toFixed(1)+'x'; saveSettings(); };
    els.pitch.oninput= ()=>{ els.pitchLabel.textContent= Number(els.pitch.value).toFixed(1); saveSettings(); };

    // Init
    function init(){
      fillLangs(); loadSettings(); uiProvider(); populateVoices(); setupLevel();
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
      if(isIOS) els.warn.style.display='inline-flex';
      if(location.protocol==='file:'){
        els.testLog.value += 'â„¹ï¸ DosyayÄ± file:// Ã¼zerinden aÃ§tÄ±nÄ±z. MÃ¼mkÃ¼nse localhost veya https Ã¼stÃ¼nden Ã§alÄ±ÅŸtÄ±rÄ±n.\n';
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ els.testLog.value += 'âŒ Bu tarayÄ±cÄ±da Web Speech Recognition yok. Chrome/Edge kullanÄ±n.\n'; } else { els.testLog.value += 'âœ… SR mevcudiyet kontrolÃ¼: VAR\n'; }
    }

    // Self Tests
    function logOk(msg){ els.testLog.value += `âœ… ${msg}\n`; }
    function logErr(msg){ els.testLog.value += `âŒ ${msg}\n`; }
    function setSummary(){ const lines = els.testLog.value.trim().split(/\n/).filter(Boolean); const ok=lines.filter(l=>l.startsWith('âœ…')).length; const bad=lines.filter(l=>l.startsWith('âŒ')).length; els.testSummary.textContent = `${ok} OK, ${bad} Hata`; els.testSummary.className = bad? 'err':'ok'; }
    async function runSelfTests(){
      els.testLog.value='';
      try{ if(typeof startMe==='function' && typeof stopMe==='function') logOk('startMe/stopMe tanÄ±mlÄ±'); else logErr('startMe/stopMe yok'); }catch(e){ logErr('startMe/stopMe eriÅŸilemedi'); }
      try{ if(typeof speakOnce==='function' && typeof speakOnceSafe==='function') logOk('speakOnce / speakOnceSafe var'); else logErr('speakOnce/safe yok'); }catch(e){ logErr('speakOnce eriÅŸilemedi'); }
      try{ const pWas=els.provider.value; els.provider.value='none'; const out=await translateText('merhaba','tr-TR','en-US'); if(out==='merhaba') logOk('provider=none passthrough'); else logErr('passthrough baÅŸarÄ±sÄ±z'); els.provider.value=pWas; }catch(e){ logErr('translateText test Ã§alÄ±ÅŸmadÄ±'); }
      try{ const q0=tts.queue.length; speakOnceSafe('toOther','TEST', 'en-US'); const q1=tts.queue.length; speakOnceSafe('toOther','TEST', 'en-US'); const q2=tts.queue.length; if(q2===q1) logOk('TTS dedupe Ã§alÄ±ÅŸÄ±yor'); else logErr('TTS dedupe Ã§alÄ±ÅŸmÄ±yor'); }catch(e){ logErr('TTS kuyruÄŸu test edilemedi'); }
      setSummary();
    }

    els.runTests.onclick = runSelfTests;

    init();
  })();
  </script>
</body>
</html>
